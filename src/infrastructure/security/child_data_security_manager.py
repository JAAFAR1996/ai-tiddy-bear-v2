import loggingfrom datetime import datetimefrom typing import Any, Dict, Optionalfrom src.infrastructure.security.child_data_encryption import ChildDataEncryptionfrom src.infrastructure.security.coppa_compliance_service import COPPAComplianceServicefrom src.infrastructure.logging_config import get_loggerlogger = get_logger(__name__, component="security")class ChildDataSecurityManager:    """    Enhanced child data security manager    """    def __init__(self, encryption_key: Optional[str] = None) -> None:        self.encryption = ChildDataEncryption(encryption_key)        self.coppa_service = COPPAComplianceService(self.encryption)    def secure_child_profile(        self, child_data: Dict[str, Any], parent_consent: Dict[str, Any]    ) -> Dict[str, Any]:        """Secure child profile with COPPA compliance"""        try:            # Create COPPA consent record            consent_record = self.encryption.create_consent_record(                child_id=child_data.get("id", ""),                consent_method=parent_consent.get("method", "digital"),                ip_address=parent_consent.get("ip_address"),            )            compliance_check = self.encryption.validate_coppa_compliance(                child_data, consent_record            )            if not compliance_check["compliant"]:                raise ValueError(                    f"COPPA compliance violations: {compliance_check['violations']}"                )            # Encrypt sensitive data            encrypted_data = self.encryption.encrypt_child_data(child_data)            # Add compliance information            encrypted_data["_coppa_compliance"] = {                "consent_timestamp": consent_record.consent_timestamp.isoformat(),                "data_retention_expires": consent_record.data_retention_expires.isoformat(),                "compliance_verified": True,            }            return encrypted_data        except Exception as e:            logger.error(f"Failed to secure child profile: {e}")            raise    def get_child_data_for_interaction(        self, encrypted_child_data: Dict[str, Any]    ) -> Dict[str, Any]:        """Get child data for interaction with COPPA check"""        try:            # Decrypt data            decrypted_data = self.encryption.decrypt_child_data(encrypted_child_data)            # Check data expiration            coppa_info = encrypted_child_data.get("_coppa_compliance", {})            if coppa_info.get("data_retention_expires"):                expiry = datetime.fromisoformat(coppa_info["data_retention_expires"])                if datetime.utcnow() > expiry:                    raise ValueError(                        "Child data retention period expired - data access denied"                    )            return decrypted_data        except Exception as e:            logger.error(f"Failed to get child data for interaction: {e}")            raise    def schedule_data_cleanup(self) -> Dict[str, Any]:        """Schedule cleanup of expired data"""        expired_records = self.coppa_service.check_data_retention_compliance()        cleanup_summary = {            "total_expired": len(expired_records),            "expired_records": expired_records,            "cleanup_scheduled": datetime.utcnow().isoformat(),        }        if expired_records:            logger.warning(                f"Found {len(expired_records)} child records requiring data deletion"            )        return cleanup_summary