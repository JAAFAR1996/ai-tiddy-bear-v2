"""Response Enhancer for ChatGPT - Child-Friendly Response Enhancement"""

import random
import re
from typing import Any

from src.infrastructure.logging_config import get_logger

logger = get_logger(__name__, component="infrastructure")

PRESCHOOL_MAX_AGE = 5
ELEMENTARY_MAX_AGE = 8
EMOJI_PROBABILITY = 0.3
MAX_ENHANCEMENT_ATTEMPTS = 3


class ResponseEnhancer:
    """Response enhancer for child-friendly AI interactions."""

    def __init__(self) -> None:
        # Encouraging phrases for children
        self.encouraging_phrases = [
            "That's a great question!",
            "You're so curious!",
            "I love how you think!",
            "What a wonderful idea!",
            "You're very smart!",
            "That's fantastic!",
            "Keep exploring!",
            "You're doing great!",
        ]
        # Child-friendly emojis
        self.child_friendly_emojis = [
            "๐",
            "๐",
            "๐",
            "๐ฆ",
            "๐ธ",
            "๐จ",
            "๐",
            "๐ต",
            "๐ป",
            "๐ฆ",
            "๐ฑ",
            "๐ถ",
            "๐",
            "โญ",
            "๐ช",
            "๐ญ",
        ]
        # Follow-up questions
        self.follow_up_questions = [
            "What do you think about that?",
            "Would you like to know more?",
            "What's your favorite part?",
            "Can you tell me more?",
            "What would you do?",
            "How does that make you feel?",
            "What else would you like to explore?",
        ]

    def enhance_response_for_children(
        self, response: str, child_age: int, preferences: dict[str, Any] = None
    ) -> str:
        """Enhance response for children with age-appropriate content."""
        preferences = preferences or {}
        # Apply age-specific enhancements
        enhanced = self._apply_age_specific_enhancements(response, child_age)
        # Add interactive elements
        enhanced = self._add_interactive_elements(enhanced, child_age)
        # ุฅุถุงูุฉ ุงูุชุดุฌูุน
        enhanced = self._add_encouragement(enhanced)
        # ุฅุถุงูุฉ ุณุคุงู ูููุชุงุจุนุฉ
        enhanced = self._add_follow_up_question(enhanced)
        # ุชุทุจูู ุชูุถููุงุช ุงูุทูู
        enhanced = self._apply_child_preferences(enhanced, preferences)
        return enhanced

    def _apply_age_specific_enhancements(self, response: str, child_age: int) -> str:
        """ุชุทุจูู ุชุญุณููุงุช ุฎุงุตุฉ ุจุงูุนูุฑ"""
        if child_age <= 4:
            # ููุฃุทูุงู ุงูุตุบุงุฑ: ุฌูู ูุตูุฑุฉ ููููุงุช ุจุณูุทุฉ
            response = self._simplify_language(response)
            response = self._add_repetition(response)
        elif child_age <= 7:
            # ููุฃุทูุงู ุงููุชูุณุทูู: ุฅุถุงูุฉ ุฃุตูุงุช ูุญุฑูุงุช
            response = self._add_sound_effects(response)
        elif child_age <= 10:
            # ููุฃุทูุงู ุงูุฃูุจุฑ: ุฅุถุงูุฉ ูุนูููุงุช ุชุนููููุฉ
            response = self._add_educational_elements(response)
        return response

    def _simplify_language(self, response: str) -> str:
        """ุชุจุณูุท ุงููุบุฉ ููุฃุทูุงู ุงูุตุบุงุฑ"""
        # ุงุณุชุจุฏุงู ุงููููุงุช ุงููุนูุฏุฉ ุจูููุงุช ุจุณูุทุฉ
        replacements = {
            "magnificent": "beautiful",
            "extraordinary": "amazing",
            "immediately": "right now",
            "definitely": "yes",
            "probably": "maybe",
            "understand": "know",
            "remember": "think of",
            "interesting": "cool",
            "wonderful": "great",
            "fantastic": "awesome",
        }
        for complex_word, simple_word in replacements.items():
            response = re.sub(
                r"\b" + re.escape(complex_word) + r"\b",
                simple_word,
                response,
                flags=re.IGNORECASE,
            )
        # ุชูุณูู ุงูุฌูู ุงูุทูููุฉ
        sentences = response.split(". ")
        short_sentences = []
        for sentence in sentences:
            if len(sentence.split()) > 8:  # ุฅุฐุง ูุงูุช ุงูุฌููุฉ ุทูููุฉ
                # ุชูุณูููุง ุฅูู ุฌูู ุฃูุตุฑ
                words = sentence.split()
                mid = len(words) // 2
                short_sentences.append(" ".join(words[:mid]) + ".")
                short_sentences.append(" ".join(words[mid:]))
            else:
                short_sentences.append(sentence)
        return ". ".join(short_sentences)

    def _add_repetition(self, response: str) -> str:
        """ุฅุถุงูุฉ ุงูุชูุฑุงุฑ ููุฃุทูุงู ุงูุตุบุงุฑ"""
        # ุฅุถุงูุฉ ุชูุฑุงุฑ ูููููุงุช ุงููููุฉ
        important_words = ["fun", "happy", "good", "nice", "pretty"]
        for word in important_words:
            if word in response.lower():
                response = re.sub(
                    r"\b" + re.escape(word) + r"\b",
                    f"{word}, very {word}",
                    response,
                    flags=re.IGNORECASE,
                    count=1,  # ููุท ูุฑุฉ ูุงุญุฏุฉ ูุชุฌูุจ ุงูุฅูุฑุงุท
                )
        return response

    def _add_sound_effects(self, response: str) -> str:
        """ุฅุถุงูุฉ ุงูุฃุตูุงุช ููุฃุทูุงู"""
        sound_mappings = {
            "cat": "meow",
            "dog": "woof",
            "cow": "moo",
            "bird": "tweet",
            "car": "vroom",
            "train": "choo-choo",
            "water": "splash",
            "wind": "whoosh",
        }
        for word, sound in sound_mappings.items():
            if word in response.lower():
                response = response.replace(word, f"{word} ({sound})", 1)
        return response

    def _add_educational_elements(self, response: str) -> str:
        """ุฅุถุงูุฉ ุนูุงุตุฑ ุชุนููููุฉ"""
        # ุฅุถุงูุฉ ุญูุงุฆู ุจุณูุทุฉ
        educational_additions = {
            "animals": "Did you know that animals have families just like us?",
            "colors": "Colors make the world beautiful and bright!",
            "numbers": "Numbers help us count and understand the world!",
            "nature": "Nature is full of amazing surprises!",
            "friends": "Friends make everything more fun!",
        }
        response_lower = response.lower()
        response_parts = [response]
        for topic, fact in educational_additions.items():
            if topic in response_lower:
                response_parts.append(f" {fact}")
                break  # ุฅุถุงูุฉ ุญูููุฉ ูุงุญุฏุฉ ููุท
        return "".join(response_parts)

    def _add_interactive_elements(self, response: str, child_age: int) -> str:
        """ุฅุถุงูุฉ ุนูุงุตุฑ ุชูุงุนููุฉ"""
        if child_age <= 6:
            # ููุฃุทูุงู ุงูุตุบุงุฑ: ุฅุถุงูุฉ ุฑููุฒ ุชุนุจูุฑูุฉ
            emoji = random.choice(self.child_friendly_emojis)
            response = f"{emoji} {response}"
        return response

    def _add_encouragement(self, response: str) -> str:
        """ุฅุถุงูุฉ ุงูุชุดุฌูุน"""
        # ุฅุถุงูุฉ ุนุจุงุฑุฉ ุชุดุฌูุนูุฉ ูู ุงูุจุฏุงูุฉ ุฃุญูุงูุงู
        if random.random() < 0.3:  # 30% ูู ุงูููุช
            encouragement = random.choice(self.encouraging_phrases)
            response = f"{encouragement} {response}"
        return response

    def _add_follow_up_question(self, response: str) -> str:
        """ุฅุถุงูุฉ ุณุคุงู ูููุชุงุจุนุฉ"""
        # ุฅุถุงูุฉ ุณุคุงู ูููุชุงุจุนุฉ ูู ุงูููุงูุฉ
        if not response.endswith("?"):
            question = random.choice(self.follow_up_questions)
            response = f"{response} {question}"
        return response

    def _apply_child_preferences(
        self, response: str, preferences: dict[str, Any]
    ) -> str:
        """ุชุทุจูู ุชูุถููุงุช ุงูุทูู"""
        favorite_character = preferences.get("favorite_character")
        if favorite_character:
            # ุฅุถุงูุฉ ุงูุดุฎุตูุฉ ุงูููุถูุฉ ูู ุงูุฃูุซูุฉ
            if "for example" in response.lower() or "like" in response.lower():
                response = response.replace(
                    "like", f"like {favorite_character} or like", 1
                )
        interests = preferences.get("interests", [])
        if interests:
            # ุฑุจุท ุงูุงุณุชุฌุงุจุฉ ุจุงูุงูุชูุงูุงุช
            for interest in interests[:1]:  # ุฃูู ุงูุชูุงู ููุท
                if interest not in response.lower():
                    response_parts = [
                        response,
                        f" Just like when you're interested in {interest}!",
                    ]
                    response = "".join(response_parts)
                    break
        return response

    def detect_emotion(self, response: str) -> str:
        """ุงูุชุดุงู ุงููุดุงุนุฑ ูู ุงูุงุณุชุฌุงุจุฉ"""
        emotion_keywords = {
            "happy": [
                "happy",
                "joy",
                "smile",
                "laugh",
                "fun",
                "great",
                "awesome",
                "wonderful",
            ],
            "excited": [
                "excited",
                "amazing",
                "fantastic",
                "wow",
                "incredible",
                "awesome",
            ],
            "curious": [
                "wonder",
                "question",
                "explore",
                "discover",
                "learn",
                "find out",
            ],
            "caring": [
                "care",
                "love",
                "friend",
                "help",
                "support",
                "together",
            ],
            "playful": ["play", "game", "fun", "silly", "laugh", "giggle"],
        }
        response_lower = response.lower()
        for emotion, keywords in emotion_keywords.items():
            if any(keyword in response_lower for keyword in keywords):
                return emotion
        return "friendly"  # Default emotion
